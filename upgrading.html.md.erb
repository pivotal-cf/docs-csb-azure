---
title: Upgrading Cloud Service Broker for Azure
owner: Cloud Service Broker
---

This topic tells you how to upgrade <%= vars.product_full %>.

## <a id="upgrade-to-1-4"></a> Upgrading to v1.4

### <a id="redis"></a> Upgrading to Azure Cache for Redis v6

New Redis v6 is now available through  <%= vars.product_short %>.

<p class="note">
  <strong>Note:</strong> All brokerpak-provided plans set the Redis version to v4 to maintain compatibility with the instances already created.
  These plans are deprecated and will be removed from the brokerpak in future releases in favor of custom-defined plans in the tile.
  VMware recommends that you update all instances to use custom-defined plans instead.
</p>

To update to Redis v6:

1. Before updating the Redis version, make sure you read the
[Microsoft Azure upgrade recommendations](https://learn.microsoft.com/en-us/azure/azure-cache-for-redis/cache-how-to-upgrade)
and understand any possible consequences to the service.

1. Identify the instance that you want to update to use Redis v6.

1. Identify the plan used to create the instance by running:

   ```console
   cf service INSTANCE-NAME
   ```

   Where `INSTANCE-NAME` is the name of the service to be updated.

1. Find the plan definition of the plan you identified.
   If it is a custom plan, you can find its definition in the tile configuration.
   If is is a brokerpak-provided plan, you can find the corresponding properties
   [in the brokerpak definition](https://github.com/cloudfoundry/csb-brokerpak-azure/blob/6f4a2879ea330fdedbbed896259f9f1942f2ff4b/azure-redis.yml#L26-L102)</a>.

1. If the plan is a custom plan, you can update the instance to use Redis v6 by running:

   ```console
   cf update-service INSTANCE-NAME -c '{"redis_version": "6"}'
   ```

   Where `INSTANCE-NAME` is the name of the service to be updated.

1. If the plan is a brokerpak-provided one, you can either define a plan with or without a specified
Redis version. Choose one of the following options:

    * **Option 1:** Define the custom-created plan with a specified Redis version.

        1. Define a custom plan that specifies the Redis version. For example:

            ```json
            {
              "name": "custom-plan-v6",
              "id": "ba3d28f0-6b17-11ed-91ca-1f5af50ef86f",
              "description": "Custom plan",
              "sku_name": "Basic",
              "family": "C",
              "capacity": 1,
              "tls_min_version": "1.2",
              "firewall_rules": [],
              "redis_version": "6"
            }
            ```

            <p class="note important">
            <strong>Important:</strong> All other service properties must match the plan the instance is already on.

            If you set the <code>redis_version</code> property in the plan, users cannot change
            that property during create or update instance operations.
            </p>

        1. Update the instance to the new plan by running:

           ```console
           cf update-service INSTANCE-NAME -p NEW-PLAN-NAME
           ```

           Where `NEW-PLAN-NAME` is the name of the plan created in previous step.

    * **Option 2:** Define a custom-created plan without a specified Redis version.

        1. Define a custom plan that does not specify the Redis version. For example:

            ```json
            {
               "name": "custom-plan-v6",
               "id": "ba3d28f0-6b17-11ed-91ca-1f5af50ef86f",
               "description": "Custom plan",
               "sku_name": "Basic",
               "family": "C",
               "capacity": 1,
               "tls_min_version": "1.2",
               "firewall_rules": []
            }
            ```

            <p class="note important">
              <strong>Important:</strong> All service properties, other than <code>name</code>, <code>id</code> and <code>description</code> must match the plan the instance is already on.
            </p>

        1. Update the instance to the new plan by running:

            ```console
            cf update-service INSTANCE-NAME -p NEW-PLAN-NAME -c '{"redis_version": "6"}'
            ```

            Where `NEW-PLAN-NAME` is the name of the plan created in previous step.

## <a id="procedure"></a> Upgrade procedure

<p class="note important">
   <strong>Important:</strong> When upgrading <%= vars.product_short %>, service instances might need
   to be upgraded.
   Failure to upgrade one or more instance does not cause the tile installation to fail.<br><br>
   Ensure that you review the <code>deploy-all</code> errand logs in the change log to verify that
   no errors occurred when upgrading instances. For more information about the service instance
   upgrade procedure, see <a href="#upgrade-instances">Upgrading service instances</a> later in the
   topic.
</p>

To upgrade <%= vars.product_short %>:

1. Before you stage the new tile version,
   [ensure that all service instances are up-to-date](#upgrade-instances).

2. Download the new version of <%= vars.product_short %> from
   [<%= vars.product_network %>](https://network.pivotal.io/products/cloud-service-broker-azure/).

3. Stage and configure the tile by following the instructions in
   [Installing with Azure](installing-with-azure.html.md.erb).

4. Make all the changes described in [Upgrading to v1.5](#upgrading-specifics).

5. Verify that the **Upgrade All Service Instances** task is configured as required.
   See [Upgrade All Service Instances configuration](installing-with-azure.html.md.erb#upgrade-all-config).

6. Verify that your configuration complies with the
   [important notes about upgrading service instances](#upgrade-notes), especially regarding plans
   and beta offerings.

7. Go to the <%= vars.ops_manager %> Installation Dashboard.

8. Click **Review Pending Changes** and then click **Apply Changes**.

9. Review the `deploy-all` errand logs for any errors created because of the upgrade instances task.

## <a id="upgrade-instances"></a> Ensure that service instances are up-to-date before upgrading the tile

Service instance upgrades must be performed alongside the corresponding tile upgrade.
Service instances that haven't been upgraded with one version might not be upgradable with
upcoming versions.
For this reason, verify that there are no instances pending upgrade before upgrading the tile to a
later version.

You can see if there are instances with a pending upgrade by reviewing the last `deploy-all` errand
log for <%= vars.product_short %>. Alternatively, you can
[ensure all instances are up-to-date with the CLI plug-in](#checking-cli-plugin)
and the `-dry-run` flag, which outputs the list of instances pending upgrade.

If you find instances that are pending upgrade, reapply the service instance upgrade with the
current version of the broker before staging the new version of the tile. To reapply the instance
upgrade:

1. Ensure that you haven't staged the new version of the tile yet.
2. Review the [important notes about upgrading service instances](#upgrade-notes).
3. Follow the steps from either
    - [Upgrade instances through the tile](#upgrading-instances-task) or
    - [Upgrade instances through the CLI plug-in](#upgrading-cli-plugin) from the CLI.

### <a id="upgrade-notes"></a> Important notes about upgrading service instances

Before you start upgrading service instances, see the following notes:

- **Enabling the Upgrade all services check box:**

  If the **Upgrade all services** check box is not selected, service instances are not upgraded
  during installation. These instances become unmanageable by the broker.
  Any operations on that instance, such as update, bind, unbind, or delete, are blocked
  until you run the upgrade task.
  You can run the upgrade task at any time before upgrading the product to a later version.

- **Enabling the Enable Beta offerings check box:**

  If the **Enable Beta offerings** check box is not selected when applying changes, instances from
  those service offerings are not upgraded. These instances become unmanageable by the broker.
  Ensure that the **Enable Beta offerings** check box is selected if you have instances from those
  offerings you intend to keep updated.

- **Deleting custom plans:**

  If you delete custom plans before upgrading all instances, instances from these plans are not
  upgraded. These instances become unmanageable by the broker. Delete plans after upgrading all
  instances, or see [Release Notes for Cloud Service Broker for Azure](release-notes.html.md.erb) and
  [Upgrading to v1.5](#upgrading-specifics) to prevent conflicting upgrades.

- **Only upgrade the tile after all service instances are up-to-date:**

  You can run the upgrade all instances task as many times as needed.
  If preferred, you can run the upgrade all instances task by using the cf CLI instead of,
  or in addition to, running it through the tile.
  Failure to upgrade one or more instances does not cause the tile installation to fail.
  Review the `deploy all` errand logs to ensure that all instances have upgraded.

### <a id="checking-cli-plugin"></a> Ensure that all instances are up-to-date with the CLI plug-in

To verify that no instances are pending upgrade:

1. Install the [cf CLI UpgradeAllServices plugin](https://plugins.cloudfoundry.org/#UpgradeAllServices).
1. Follow the instructions in the **Usage** section of the `README` in the
   [upgrade-all-services-cli-plugin](https://github.com/cloudfoundry/upgrade-all-services-cli-plugin#usage)
   GitHub repository to perform a dry run.

   For example:

   ```
   cf upgrade-all-services BROKER-NAME -dry-run
   ```

This command provides a list of instances from enabled plans pending upgrade. If the list is not
empty, upgrade the instances listed before attempting a tile upgrade.

### <a id="upgrading-instances-task"></a> Upgrade instances through the tile

To upgrade service instances through the tile:

1. Configure the **Upgrade All Service Instances** task. For more information, see
   [Upgrade All Service Instances Configuration](installing-with-azure.html.md.erb#upgrade-all-config).
1. Apply the changes.
1. Review the `deploy-all` log entries for failures.

### <a id="upgrading-cli-plugin"></a> Upgrade instances through the CLI plug-in

To run the cf CLI plug-in:

1. Install the [cf CLI UpgradeAllServices plugin](https://plugins.cloudfoundry.org/#UpgradeAllServices).
1. To run the upgrade, follow the instructions in the **Usage** section of the `README` in the
   [upgrade-all-services-cli-plugin](https://github.com/cloudfoundry/upgrade-all-services-cli-plugin#usage)
   GitHub repository.

   For example:

   ```
   cf upgrade-all-services BROKER-NAME
   ```

Run the CLI plug-in with the `-dry-run` flag before applying the service instance upgrade to find
out which instances are pending upgrade.

## <a id="upgrading-specifics"></a> Upgrade to v1.5

There are currently no notes for upgrading to v1.5.
